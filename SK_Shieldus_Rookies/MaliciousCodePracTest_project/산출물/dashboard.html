<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YARA PE 파일 스캐너 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .file-drop-zone { transition: all 0.2s ease-in-out; }
        .file-drop-zone.drag-over { background-color: #374151; border-color: #3b82f6; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-button { transition: all 0.2s; }
        .tab-button.active { background-color: #3b82f6; color: #ffffff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .remove-btn { font-size: 1.2rem; line-height: 1; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex items-center justify-center p-4">
    <div class="container mx-auto max-w-5xl w-full">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">YARA 기반 PE 파일 스캐너</h1>
            <p class="text-gray-400 mt-2">YARA 룰과 PE 파일을 업로드하여 악성 여부를 검사하세요.</p>
        </header>

        <!-- Main Content -->
        <main class="bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8">
            <!-- File Upload Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- YARA Rule Upload -->
                <div id="yara-drop-zone" class="file-drop-zone border-2 border-dashed border-gray-600 rounded-lg p-6 text-center cursor-pointer flex flex-col">
                    <input type="file" id="yara-input" class="hidden" accept=".yar,.yara" multiple>
                    <div class="flex flex-col items-center">
                        <svg class="w-12 h-12 text-gray-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <p class="text-gray-400 font-semibold">YARA 룰 파일(.yar) 업로드</p>
                        <p class="text-sm text-gray-500">파일을 드래그하거나 클릭하세요 (여러 개 가능)</p>
                    </div>
                    <div id="yara-filename-container" class="w-full mt-2 space-y-1 flex-grow"></div>
                </div>

                <!-- PE File Upload -->
                <div id="pe-drop-zone" class="file-drop-zone border-2 border-dashed border-gray-600 rounded-lg p-6 text-center cursor-pointer flex flex-col">
                    <input type="file" id="pe-input" class="hidden" accept=".exe,.dll,.sys">
                    <div class="flex flex-col items-center">
                        <svg class="w-12 h-12 text-gray-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        <p class="text-gray-400 font-semibold">PE 파일(.exe, .dll) 업로드</p>
                        <p class="text-sm text-gray-500">파일을 드래그하거나 클릭하세요</p>
                    </div>
                    <div id="pe-filename-container" class="w-full mt-2 space-y-1 flex-grow"></div>
                </div>
            </div>

            <!-- Scan Button -->
            <div class="text-center mb-8">
                <button id="scan-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed disabled:transform-none" disabled>
                    검사 시작
                </button>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="bg-gray-900 rounded-lg p-6 min-h-[250px] flex flex-col">
                <div id="results-placeholder" class="text-center text-gray-500 flex-grow flex items-center justify-center">
                    <p>검사 결과를 기다리는 중입니다...</p>
                </div>
                <div id="results-loading" class="hidden flex-grow flex flex-col items-center justify-center">
                    <div class="spinner"></div>
                    <p class="mt-4 text-gray-400">파일을 분석 중입니다...</p>
                </div>
                <div id="results-container" class="hidden w-full">
                    <!-- Tab Buttons -->
                    <div class="mb-4 border-b border-gray-700">
                        <nav class="flex space-x-2" aria-label="Tabs">
                            <button id="tab-btn-yara" class="tab-button active font-medium px-4 py-2 rounded-t-lg">YARA 검사 결과</button>
                            <button id="tab-btn-pe" class="tab-button font-medium px-4 py-2 rounded-t-lg">PE 파일 정보</button>
                        </nav>
                    </div>
                    <!-- Tab Content -->
                    <div id="tab-content-yara" class="tab-content active">
                        <!-- YARA Scan Results will be dynamically inserted here -->
                    </div>
                    <div id="tab-content-pe" class="tab-content">
                        <!-- PE File Info will be dynamically inserted here -->
                    </div>
                </div>
            </div>

        </main>
        
        <footer class="text-center text-gray-600 text-sm mt-6">
            <p>SK쉴더스 루키즈 26AI 3조 미니프로젝트</p>
        </footer>
    </div>

<script>
    // DOM Elements
    const yaraDropZone = document.getElementById('yara-drop-zone');
    const yaraInput = document.getElementById('yara-input');
    const yaraFilenameContainer = document.getElementById('yara-filename-container');

    const peDropZone = document.getElementById('pe-drop-zone');
    const peInput = document.getElementById('pe-input');
    const peFilenameContainer = document.getElementById('pe-filename-container');

    const scanButton = document.getElementById('scan-button');
    
    const resultsSection = document.getElementById('results-section');
    const resultsPlaceholder = document.getElementById('results-placeholder');
    const resultsLoading = document.getElementById('results-loading');
    const resultsContainer = document.getElementById('results-container');
    
    const tabBtnYara = document.getElementById('tab-btn-yara');
    const tabBtnPe = document.getElementById('tab-btn-pe');
    const tabContentYara = document.getElementById('tab-content-yara');
    const tabContentPe = document.getElementById('tab-content-pe');


    // File state
    let yaraFiles = [];
    let peFile = null;

    // --- Tab Logic ---
    function switchTab(activeTab) {
        const tabs = { yara: [tabBtnYara, tabContentYara], pe: [tabBtnPe, tabContentPe] };
        Object.entries(tabs).forEach(([key, [btn, content]]) => {
            btn.classList.toggle('active', key === activeTab);
            content.classList.toggle('active', key === activeTab);
        });
    }
    tabBtnYara.addEventListener('click', () => switchTab('yara'));
    tabBtnPe.addEventListener('click', () => switchTab('pe'));

    // --- File Upload Logic ---
    function setupDropZone(dropZone, input, isMultiple, fileStateSetter, displayHandler) {
        dropZone.addEventListener('click', () => input.click());
        
        const handleFiles = (files) => {
            if (files?.length > 0) {
                fileStateSetter(isMultiple ? Array.from(files) : files[0]);
                displayHandler(isMultiple ? yaraFiles : peFile);
                checkFiles();
            }
        };

        input.addEventListener('change', (e) => handleFiles(e.target.files));
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                input.files = e.dataTransfer.files;
                handleFiles(e.dataTransfer.files);
            }
        });
    }
    
    // --- Display and Remove Logic ---
    function displayYaraFilenames(files) {
        yaraFilenameContainer.innerHTML = '';
        files.forEach((file, index) => {
            const fileElement = document.createElement('div');
            fileElement.className = 'flex items-center justify-between text-blue-400 text-sm px-2 py-1 bg-gray-700/50 rounded-md';
            fileElement.innerHTML = `<span class="truncate" title="${escapeHtml(file.name)}">${escapeHtml(file.name)}</span>
                                     <button class="remove-btn ml-2 text-gray-500 hover:text-white leading-none" data-index="${index}">&times;</button>`;
            yaraFilenameContainer.appendChild(fileElement);
        });
    }

    yaraFilenameContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-btn')) {
            const indexToRemove = parseInt(e.target.dataset.index, 10);
            yaraFiles.splice(indexToRemove, 1);
            displayYaraFilenames(yaraFiles);
            checkFiles();
        }
    });

    function displayPeFilename(file) {
        peFilenameContainer.innerHTML = file ? 
            `<div class="flex items-center justify-between text-blue-400 text-sm px-2 py-1 bg-gray-700/50 rounded-md">
                <span class="truncate" title="${escapeHtml(file.name)}">${escapeHtml(file.name)}</span>
                <button class="remove-btn ml-2 text-gray-500 hover:text-white leading-none">&times;</button>
            </div>` : '';
    }

    peFilenameContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-btn')) {
            peFile = null;
            peInput.value = '';
            displayPeFilename(null);
            checkFiles();
        }
    });

    setupDropZone(yaraDropZone, yaraInput, true, (files) => { yaraFiles = files; }, displayYaraFilenames);
    setupDropZone(peDropZone, peInput, false, (file) => { peFile = file; }, displayPeFilename);
    
    function checkFiles() {
        scanButton.disabled = !(yaraFiles.length > 0 && peFile);
    }

    // --- Scan Logic ---
    scanButton.addEventListener('click', async () => {
        if (yaraFiles.length === 0 || !peFile) return;
        
        resultsPlaceholder.classList.add('hidden');
        resultsContainer.classList.add('hidden');
        resultsLoading.classList.remove('hidden');
        
        try {
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const [yaraContents, peContentForScan, peContentForHash] = await Promise.all([
                Promise.all(yaraFiles.map(file => readFileAsText(file))),
                readFileAsText(peFile),
                readFileAsArrayBuffer(peFile)
            ]);
            
            const matches = performMockScan(yaraContents.join('\n\n'), peContentForScan);
            const hashes = await calculateHashes(peContentForHash);
            
            displayYaraResults(matches);
            displayPeInfo(peFile, hashes);
            
            resultsContainer.classList.remove('hidden');
            switchTab('yara');
        } catch (error) {
            console.error("파일 분석 중 오류 발생:", error);
            displayError("파일을 분석하는 중에 오류가 발생했습니다.");
        } finally {
            resultsLoading.classList.add('hidden');
        }
    });

    // --- File Readers ---
    function readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject(reader.error);
            reader.readAsText(file, 'ISO-8859-1');
        });
    }
    
    function readFileAsArrayBuffer(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject(reader.error);
            reader.readAsArrayBuffer(file);
        });
    }

    // --- Hashing Logic ---
    async function calculateHashes(arrayBuffer) {
        const wordArray = CryptoJS.lib.WordArray.create(arrayBuffer);
        const md5 = CryptoJS.MD5(wordArray).toString();
        const sha1 = CryptoJS.SHA1(wordArray).toString();
        const sha256 = CryptoJS.SHA256(wordArray).toString();
        return { md5, sha1, sha256 };
    }

    // --- MOCK SCANNER ---
    function performMockScan(yaraContent, peContent) {
        const matches = [];
        const ruleRegex = /rule\s+([a-zA-Z0-9_]+)\s*\{([\s\S]*?)\}/g;
        let ruleMatch;
        
        while ((ruleMatch = ruleRegex.exec(yaraContent)) !== null) {
            const ruleName = ruleMatch[1];
            const ruleBody = ruleMatch[2];
            const stringRegex = /\$\w+\s*=\s*"([^"]+)"/g;
            let stringMatch;
            
            while ((stringMatch = stringRegex.exec(ruleBody)) !== null) {
                if (peContent.includes(stringMatch[1])) {
                    matches.push({ rule: ruleName, matchedString: stringMatch[1] });
                    break; 
                }
            }
        }
        return matches;
    }

    // --- Display Results Logic ---
    function displayYaraResults(matches) {
        if (matches.length > 0) {
            const resultHeader = `<div class="flex items-center mb-4">
                <svg class="w-8 h-8 text-red-500 mr-3 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <h2 class="text-2xl font-bold text-red-400">위협 탐지됨</h2>
            </div>`;
            
            const matchElements = matches.map(match => 
                `<div class="bg-gray-800 p-4 rounded-lg mb-2 border border-gray-700">
                    <p class="font-semibold text-white">매칭된 룰: <span class="font-normal text-yellow-400">${match.rule}</span></p>
                    <p class="text-sm text-gray-400 mt-1">탐지된 문자열: <code class="bg-gray-700 p-1 rounded text-xs text-red-300">${escapeHtml(match.matchedString)}</code></p>
                </div>`
            ).join('');
            
            tabContentYara.innerHTML = resultHeader + matchElements;
        } else {
            tabContentYara.innerHTML = `<div class="flex items-center justify-center flex-col text-center h-full py-8">
                <svg class="w-12 h-12 text-green-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h2 class="text-2xl font-bold text-green-400">파일이 안전합니다</h2>
                <p class="text-gray-400 mt-1">YARA 룰과 일치하는 항목을 찾지 못했습니다.</p>
            </div>`;
        }
    }
    
    function displayPeInfo(file, hashes) {
        tabContentPe.innerHTML = `
            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold text-lg text-white mb-2">기본 정보</h3>
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 text-sm space-y-2">
                        <p><span class="font-medium text-gray-400 w-24 inline-block">파일 이름:</span> <span class="text-blue-300">${escapeHtml(file.name)}</span></p>
                        <p><span class="font-medium text-gray-400 w-24 inline-block">파일 크기:</span> <span>${(file.size / 1024).toFixed(2)} KB</span></p>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold text-lg text-white mb-2">파일 해시 (Threat Intelligence)</h3>
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 text-sm font-mono space-y-2">
                        <p><span class="font-sans font-medium text-gray-400 w-20 inline-block">MD5:</span> <a href="https://www.virustotal.com/gui/file/${hashes.md5}" target="_blank" class="text-cyan-400 hover:underline break-all">${hashes.md5}</a></p>
                        <p><span class="font-sans font-medium text-gray-400 w-20 inline-block">SHA-1:</span> <a href="https://www.virustotal.com/gui/file/${hashes.sha1}" target="_blank" class="text-cyan-400 hover:underline break-all">${hashes.sha1}</a></p>
                        <p><span class="font-sans font-medium text-gray-400 w-20 inline-block">SHA-256:</span> <a href="https://www.virustotal.com/gui/file/${hashes.sha256}" target="_blank" class="text-cyan-400 hover:underline break-all">${hashes.sha256}</a></p>
                    </div>
                </div>
            </div>
        `;
    }

    function displayError(message) {
        resultsPlaceholder.classList.remove('hidden');
        resultsPlaceholder.innerHTML = `<div class="flex items-center justify-center flex-col text-center">
            <svg class="w-12 h-12 text-yellow-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h2 class="text-2xl font-bold text-yellow-400">오류 발생</h2>
            <p class="text-gray-400 mt-1">${message}</p>
        </div>`;
    }
    
    function escapeHtml(unsafe) {
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

</script>
</body>
</html>

